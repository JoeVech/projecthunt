<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>AR –ó–≤–µ—Ä–∏ - –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' 'unsafe-inline' data: blob:;
        script-src 'self' 'unsafe-inline' cdn.jsdelivr.net aframe.io cdnjs.cloudflare.com unpkg.com telegramsdk.com;
        connect-src 'self' data: blob:;
        media-src 'self' blob: data:;
        style-src 'self' 'unsafe-inline';
    ">

    <!-- –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="/css/main.css">

    <!-- A-Frame —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –∏ SRI -->
    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"
        integrity="sha512-7bLAIQFZmmwpSXr3R6W3X6XyZNMp1QudGAmZvufDPhm7ZJh2eNcj+acF5Z5Qglj/EDv4wSJjMH2uAVx3Z4i2A==" 
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
        onerror="loadFallback(this, 'aframe')"
    ></script>

    <!-- AR.js —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º CDN -->
    <script 
        src="https://unpkg.com/@ar-js/ar.js@3.3.0/aframe/build/aframe-ar-nft.min.js"
        crossorigin="anonymous"
        onerror="loadFallback(this, 'arjs')"
    ></script>

    <!-- Telegram Web App SDK —Å –ª–æ–∫–∞–ª—å–Ω—ã–º fallback -->
    <script 
        src="https://telegram.org/js/telegram-web-app.js" 
        onerror="loadFallback(this, 'telegram')"
    ></script>
    <script>
        window.Telegram = window.Telegram || {
            WebApp: {
                ready: () => console.warn('Telegram SDK not loaded!'),
                expand: () => {},
                enableClosingConfirmation: () => {}
            }
        };
    </script>
    <!-- –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª -->
    <script src="/js/aframe.min.js"></script>
</head>
<body>
    <div class="loader">
        <button id="startButton" class="tg-button">
            <span class="button-text">üéÆ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å AR</span>
            <div class="loading-spinner hidden"></div>
        </button>
        <div id="status" class="status-text">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!</div>
    </div>

    <!-- AR —Å—Ü–µ–Ω–∞ -->
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="debugUIEnabled: false; trackingMethod: best;"
        renderer="logarithmicDepthBuffer: true;"
        class="hidden"
        data-loaded="false"
    >
        <a-camera gps-camera rotation-reader></a-camera>
        <a-entity id="animal" arjs-anchor="detectedPlanes: true;" visible="false">
            <a-box position="0 0.5 0" color="#4CAF50" scale="0.5 0.5 0.5"></a-box>
            <a-text value="ü¶ä –î–∏–∫–∏–π –∑–≤–µ—Ä—å!" position="0 1.2 0" align="center" color="#FFF"></a-text>
            <a-animation attribute="rotation" to="0 360 0" dur="5000" repeat="indefinite"></a-animation>
        </a-entity>
    </a-scene>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ -->
    <script src="/js/telegram-api.js" type="module"></script>
    <script src="/js/ar-config.js" type="module"></script>
    <script src="/js/app.js" type="module"></script>

    <!-- –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            console.error('Global Error:', e.error);
            showFatalError(e.error);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
        function loadFallback(failedScript, libName) {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${libName}:`, failedScript.src);
            const errorMessage = `
                <div class="error-box">
                    <h2>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${libName}.</p>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:</p>
                    <ul>
                        <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</li>
                        <li>–û—Ç–∫–ª—é—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤</li>
                        <li>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
                    </ul>
                    <button onclick="window.location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            `;
            document.body.innerHTML = errorMessage;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞—Ç–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
        function showFatalError(error) {
            document.body.innerHTML = `
                <div class="fatal-error">
                    <h2>üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</h2>
                    <pre>${error.stack || error.message}</pre>
                    <button onclick="window.location.reload()">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
            `;
        }
    </script>
</body>
</html>
