<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Camera Final</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Content Security Policy для блокировки расширений -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.jsdelivr.net aframe.io; script-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.jsdelivr.net aframe.io; connect-src 'self' blob:;">
    
    <!-- Порядок подключения важен! -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.0/aframe/build/aframe-ar.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        .arjs-loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="arjs-loader">Инициализация AR...</div>
    
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
        renderer="logarithmicDepthBuffer: true;"
    >
        <a-camera gps-camera rotation-reader></a-camera>
        
        <!-- Тестовый объект -->
        <a-box 
            position="0 0 -2" 
            material="color: #4CAF50" 
            scale="0.5 0.5 0.5"
            arjs-anchor="detectedPlanes: true;"
            visible="false"
        >
            <a-animation 
                attribute="rotation"
                to="0 360 0"
                dur="5000"
                repeat="indefinite">
            </a-animation>
        </a-box>
    </a-scene>

    <script>
        (function() { // Изолируем область видимости
            // Агрессивная блокировка Web3 API
            const disableWeb3 = () => {
                delete window.ethereum;
                delete window.web3;
                delete window.BinanceChain;
                Object.defineProperties(window, {
                    ethereum: { get: () => undefined },
                    web3: { get: () => undefined },
                    BinanceChain: { get: () => undefined }
                });
            };
            
            disableWeb3();
            setInterval(disableWeb3, 1000);

            // Инициализация сцены
            document.querySelector('a-scene').addEventListener('loaded', () => {
                document.querySelector('.arjs-loader').style.display = 'none';
                
                // Принудительная инициализация видео
                const video = document.querySelector('video');
                if(video) {
                    video.style.position = 'fixed';
                    video.style.top = '0';
                    video.style.left = '0';
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.zIndex = '-1';
                }
            });

            // Обработка ошибок
            window.addEventListener('arjs-source-error', (error) => {
                console.error('AR Error:', error.detail.error);
                document.querySelector('.arjs-loader').innerHTML = `
                    Ошибка AR:<br>
                    ${error.detail.error.message}<br>
                    Попробуйте:<br>
                    1. Перезагрузить страницу<br>
                    2. Проверить разрешения камеры<br>
                    3. Отключить все расширения
                `;
            });

            // Инициализация Telegram Web App
            if(typeof Telegram !== 'undefined') {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
            }
        })();
    </script>
</body>
</html>
