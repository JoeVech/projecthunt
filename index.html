<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR –ó–≤–µ—Ä–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π CSP -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.jsdelivr.net aframe.io;
        connect-src 'self' blob: data:;
        media-src 'self' blob: data:;
        style-src 'self' 'unsafe-inline';
    ">
    
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.0/aframe/build/aframe-ar-nft.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body { 
            margin: 0;
            background: #000;
            touch-action: none;
        }
        
        #cameraOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            transform: scaleX(1);
        }

        .arjs-loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 1000;
        }
        
        #startButton {
            padding: 15px 30px;
            font-size: 18px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <div class="arjs-loader">
        <div id="status">–î–ª—è –Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</div>
        <button id="startButton">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å AR-–∫–∞–º–µ—Ä—É</button>
    </div>

    <video id="cameraOverlay" autoplay muted playsinline></video>

    <a-scene vr-mode-ui="enabled: false" embedded arjs renderer="logarithmicDepthBuffer: true;">
        <a-camera id="arCamera" gps-camera rotation-reader></a-camera>
        <!-- –ú–æ–¥–µ–ª—å –∑–≤–µ—Ä—è -->
        <a-entity id="animal" arjs-anchor="detectedPlanes: true;" visible="false">
            <a-box position="0 0.5 0" color="#4CAF50" scale="0.5 0.5 0.5"></a-box>
        </a-entity>
    </a-scene>

    <script>
        (function() {
            const tg = window.Telegram?.WebApp;
            const startButton = document.getElementById('startButton');
            const status = document.getElementById('status');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
            if(tg) {
                tg.ready();
                tg.expand();
                tg.enableClosingConfirmation();
            }

            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
            let isCameraStarted = false;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
            startButton.addEventListener('click', async () => {
                if(isCameraStarted) return;
                isCameraStarted = true;
                
                startButton.style.opacity = '0.5';
                startButton.disabled = true;
                status.textContent = '–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...';

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });

                    await initAR(stream);
                    document.querySelector('.arjs-loader').style.display = 'none';
                    
                } catch(error) {
                    status.innerHTML = `–û—à–∏–±–∫–∞: ${error.name}<br>${emojifyError(error)}`;
                    startButton.style.opacity = '1';
                    startButton.disabled = false;
                    isCameraStarted = false;
                }
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR
            async function initAR(stream) {
                const video = document.getElementById('cameraOverlay');
                video.srcObject = stream;
                
                await new Promise(resolve => {
                    video.onloadedmetadata = resolve;
                    video.play();
                });

                const scene = document.querySelector('a-scene');
                scene.systems['arjs']._arAnchorSystem.configuration.source = video;
                scene.systems['arjs']._arAnchorSystem.start();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
                status.textContent = '–ò—â–µ–º –ø–ª–æ—Å–∫–æ—Å—Ç–∏...';
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            function emojifyError(error) {
                const errors = {
                    'NotAllowedError': 'üö´ –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω',
                    'NotFoundError': 'üì∑ –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞',
                    'NotReadableError': '‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ',
                    'OverconstrainedError': 'üîç –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–º–µ—Ä—ã',
                    'SecurityError': 'üõ°Ô∏è –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
                    'AbortError': '‚èπÔ∏è –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º'
                };
                return errors[error.name] || error.message;
            }
        })();
    </script>
</body>
</html>
