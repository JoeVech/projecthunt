<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR –ó–≤–µ—Ä–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π CSP -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' 'unsafe-inline' data: blob:;
        script-src 'self' 'unsafe-inline' cdn.jsdelivr.net aframe.io;
        connect-src 'self' data: blob:;
        media-src 'self' blob: data:;
    ">
    
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.0/aframe/build/aframe-ar-nft.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body { 
            margin: 0;
            background: #000;
            overflow: hidden;
            touch-action: none;
        }
        
        #cameraContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 1000;
        }
        
        #initButton {
            padding: 15px 30px;
            font-size: 18px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: 0.3s;
        }
    </style>
</head>
<body>
    <div class="loader">
        <div id="status">üëã –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞</div>
        <button id="initButton">–ó–∞–ø—É—Å—Ç–∏—Ç—å AR-–∫–∞–º–µ—Ä—É</button>
    </div>

    <div id="cameraContainer"></div>

    <a-scene 
        vr-mode-ui="enabled: false"
        embedded 
        arjs="debugUIEnabled: false; trackingMethod: best;"
        renderer="logarithmicDepthBuffer: true;"
        style="display: none"
    >
        <a-camera id="arCamera"></a-camera>
        <a-entity id="animal" arjs-anchor="detectedPlanes: true;" visible="false">
            <a-box position="0 0.5 0" color="#4CAF50" scale="0.5 0.5 0.5"></a-box>
        </a-entity>
    </a-scene>

    <script>
        (function() {
            const tg = window.Telegram?.WebApp;
            const initButton = document.getElementById('initButton');
            const status = document.getElementById('status');
            let arStream = null;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
            if(tg) {
                tg.ready();
                tg.expand();
                tg.enableClosingConfirmation();
            }

            // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            async function initializeAR() {
                try {
                    // 1. –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
                    status.innerHTML = 'üîí –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã...';
                    const stream = await requestCameraAccess();
                    
                    // 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–∏–¥–µ–æ—ç–ª–µ–º–µ–Ω—Ç–∞
                    status.innerHTML = 'üì∑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã...';
                    const video = await setupVideoElement(stream);
                    
                    // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR-—Å—Ü–µ–Ω—ã
                    status.innerHTML = 'üöÄ –ó–∞–ø—É—Å–∫ AR...';
                    await initializeARScene(video);
                    
                    // 4. –§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
                    document.querySelector('.loader').style.display = 'none';
                    document.querySelector('a-scene').style.display = 'block';
                    
                } catch(error) {
                    handleError(error);
                }
            }

            // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
            async function requestCameraAccess() {
                return navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 60 }
                    }
                });
            }

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            async function setupVideoElement(stream) {
                return new Promise((resolve) => {
                    const video = document.createElement('video');
                    video.setAttribute('autoplay', '');
                    video.setAttribute('playsinline', '');
                    video.setAttribute('muted', '');
                    video.style.transform = 'scaleX(1)';
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'cover';
                    video.srcObject = stream;
                    
                    video.onloadedmetadata = () => {
                        video.play().then(() => resolve(video));
                    };
                    
                    document.getElementById('cameraContainer').appendChild(video);
                    arStream = stream;
                });
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR —Å—Ü–µ–Ω—ã
            async function initializeARScene(video) {
                return new Promise((resolve) => {
                    const scene = document.querySelector('a-scene');
                    
                    scene.addEventListener('loaded', () => {
                        const arSystem = scene.systems['arjs'];
                        arSystem._arAnchorSystem.configuration.source = video;
                        arSystem._arAnchorSystem.configuration.sourceType = 'video';
                        arSystem._arAnchorSystem.start();
                        resolve();
                    });
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            function handleError(error) {
                console.error('Error:', error);
                status.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.name || 'Unknown Error'}<br>${error.message}`;
                initButton.style.display = 'block';
                if(arStream) {
                    arStream.getTracks().forEach(track => track.stop());
                }
            }

            // –ó–∞–ø—É—Å–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
            initButton.addEventListener('click', () => {
                initButton.style.display = 'none';
                initializeAR();
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–æ–≤
            if(!/Mobi|Android/i.test(navigator.userAgent)) {
                initializeAR();
            }
        })();
    </script>
</body>
</html>
