<!DOCTYPE html>
<html>
<head>
    <title>GeoHunter Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; }
        .controls { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        button { padding: 12px; margin: 5px; background: #4CAF50; border: none; color: white; border-radius: 5px; cursor: pointer; }
    </style>
    
    <!-- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Web3-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π -->
    <script>
        window.addEventListener('load', () => {
            delete window.ethereum;
            delete window.web3;
            Object.defineProperties(window, {
                ethereum: { get: () => undefined },
                web3: { get: () => undefined }
            });
        });
    </script>

    <!-- OpenLayers —á–µ—Ä–µ–∑ jsDelivr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <button onclick="updatePosition()">üìç –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="switchTileSource()">üîÑ –¢–∞–π–ª—ã</button>
    </div>

    <script>
        let map;
        let playerMarker;
        const TILE_SOURCES = [
            {
                name: 'OSM Standard',
                url: 'https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png'
            },
            {
                name: 'OSM Humanitarian',
                url: 'https://{a-c}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png'
            },
            {
                name: 'ArcGIS World',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}'
            }
        ];
        let currentTileIndex = 0;

        function initMap(lat, lon) {
            map = new ol.Map({
                target: 'map',
                layers: [createTileLayer()],
                view: new ol.View({
                    center: ol.proj.fromLonLat([lon, lat]),
                    zoom: 15
                })
            });

            addPlayerMarker(lat, lon);
            addErrorHandling();
        }

        function createTileLayer() {
            return new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: TILE_SOURCES[currentTileIndex].url,
                    crossOrigin: 'anonymous'
                })
            });
        }

        function addPlayerMarker(lat, lon) {
            playerMarker = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [
                        new ol.Feature({
                            geometry: new ol.geom.Point(
                                ol.proj.fromLonLat([lon, lat])
                            )
                        })
                    ]
                }),
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                        src: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%234CAF50"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6 12 6s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/></svg>'
                    })
                })
            });
            map.addLayer(playerMarker);
        }

        function addErrorHandling() {
            map.getLayers().item(0).getSource().on('tileloaderror', () => {
                console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–π–ª–æ–≤. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫...');
                currentTileIndex = (currentTileIndex + 1) % TILE_SOURCES.length;
                map.getLayers().item(0).setSource(createTileLayer().getSource());
            });
        }

        function updatePosition() {
            navigator.geolocation.getCurrentPosition(pos => {
                const [lon, lat] = [pos.coords.longitude, pos.coords.latitude];
                map.getView().setCenter(ol.proj.fromLonLat([lon, lat]));
                playerMarker.getSource().clear();
                playerMarker.getSource().addFeature(
                    new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat([lon, lat])))
                );
            }, error => {
                alert(`–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ${error.message}`);
            });
        }

        function switchTileSource() {
            currentTileIndex = (currentTileIndex + 1) % TILE_SOURCES.length;
            map.getLayers().item(0).setSource(createTileLayer().getSource());
            alert(`–ò—Å—Ç–æ—á–Ω–∏–∫ —Ç–∞–π–ª–æ–≤: ${TILE_SOURCES[currentTileIndex].name}`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        Telegram.WebApp.ready();
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                initMap(pos.coords.latitude, pos.coords.longitude);
            }, () => {
                initMap(44.9482, 34.1003); // Fallback –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            });
        } else {
            initMap(44.9482, 34.1003);
            alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º');
        }
    </script>
</body>
</html>
