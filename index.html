<!DOCTYPE html>
<html>
<head>
    <title>GeoHunter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
        }
    </style>
    <!-- –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è OpenLayers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css">
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
</head>
<body>
    <div id="map"></div>
    <button class="refresh-btn" onclick="updatePosition()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>

    <script>
        let map;
        let playerMarker;
        const tileProviders = [
            {
                name: 'OpenStreetMap',
                url: 'https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png'
            },
            {
                name: 'CARTO',
                url: 'https://{a-c}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'
            },
            {
                name: 'CyclOSM',
                url: 'https://{a-c}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png'
            }
        ];
        let currentTile = 0;

        function initMap(lat, lon) {
            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.XYZ({
                            url: tileProviders[currentTile].url
                        })
                    })
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([lon, lat]),
                    zoom: 15
                })
            });

            // –ú–∞—Ä–∫–µ—Ä –∏–≥—Ä–æ–∫–∞
            playerMarker = new ol.layer.Vector({
                source: new ol.source.Vector(),
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                        src: 'https://docs.maptiler.com/openlayers/default-marker.png',
                        scale: 0.8
                    })
                })
            });
            map.addLayer(playerMarker);
            updatePosition(lat, lon);
        }

        function updatePosition() {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                
                const newPos = ol.proj.fromLonLat([lon, lat]);
                map.getView().setCenter(newPos);
                
                playerMarker.getSource().clear();
                playerMarker.getSource().addFeature(
                    new ol.Feature(new ol.geom.Point(newPos))
                );

            }, error => {
                console.error('Geolocation error:', error);
                try {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–π–ª–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    currentTile = (currentTile + 1) % tileProviders.length;
                    map.getLayers().item(0).setSource(
                        new ol.source.XYZ({ url: tileProviders[currentTile].url })
                    );
                } catch(e) {
                    document.getElementById('map').innerHTML = 
                        '<p style="padding:20px">–ö–∞—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</p>';
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        Telegram.WebApp.ready();
        navigator.geolocation.getCurrentPosition(pos => {
            initMap(pos.coords.latitude, pos.coords.longitude);
        }, () => {
            initMap(44.9482, 34.1003); // Fallback –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        });
    </script>
</body>
</html>
